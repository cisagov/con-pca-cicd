  
version: "3"

services:
  web:
    container_name: cpa_web
    build:
        context: .
        dockerfile: ./etc/Dockerfile
    restart: on-failure
    ports:
        - "8080:8080"
    env_file:
        - .env

  rabbitmq:
    image: rabbitmq:latest
    container_name: cpa_rabbitmq
    hostname: rabbitmq
    restart: on-failure
    ports:
      - "5672:5672"
    env_file:
      - .env

  celery-beat:
    build:
      context: .
      dockerfile: ./etc/Dockerfile
    container_name: celery-beat
    hostname: celery-beat
    restart: on-failure
    entrypoint: "celery beat -A src.config.tasks:celery --schedule=/tmp/celerybeat-schedule --loglevel=INFO --pidfile=/tmp/celerybeat.pid"
    volumes:
      - .:/app
    env_file:
      - .env

  celery-worker:
    build:
      context: .
      dockerfile: ./etc/Dockerfile
    container_name: celery-worker
    hostname: celery-worker
    restart: on-failure
    entrypoint: "celery -A src.config.tasks:celery worker --concurrency 2 --loglevel=info"
    volumes:
      - .:/app
    env_file:
      - .env
